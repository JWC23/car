/**************************************************************************//**
 * @file    battery.c
 * $Date:   2021/2/23 09:48 $
 * @brief   Battery related functions source.
 *
 * @author JW Chang
 *
*****************************************************************************/
#include "main.h"
#include "battery.h"
#include "power.h"



sBatteryData_t g_sBatteryData = {0};
uint8_t g_u8BattFlags = 0;

// const uint16_t g_au16OcvTable[][2] = {
//     // {18466, 0},
//     {0, 0},      {20874, 1},  {21967, 2},  {22720, 3},  {23306, 4},  {23768, 5},  {24147, 6},  {24447, 7},  {24660, 8},  {24801, 9},
//     {24903, 10}, {24983, 11}, {25043, 12}, {25097, 13}, {25131, 14}, {25174, 15}, {25225, 16}, {25279, 17}, {25331, 18}, {25378, 19},
//     {25743, 30}, {25767, 31}, {25790, 32}, {25812, 33}, {25832, 34}, {25850, 35}, {25867, 36}, {25882, 37}, {25896, 38}, {25908, 39},
//     {25920, 40}, {25931, 41}, {25941, 42}, {25950, 43}, {25959, 44}, {25968, 45}, {25975, 46}, {25983, 47}, {25990, 48}, {25996, 49},
//     {26003, 50}, {26009, 51}, {26015, 52}, {26021, 53}, {26027, 54}, {26033, 55}, {26038, 56}, {26044, 57}, {26050, 58}, {26055, 59},
//     {26061, 60}, {26067, 61}, {26073, 62}, {26079, 63}, {26085, 64}, {26092, 65}, {26099, 66}, {26106, 67}, {26114, 68}, {26122, 69},
//     {26132, 70}, {26143, 71}, {26155, 72}, {26169, 73}, {26185, 74}, {26202, 75}, {26219, 76}, {26237, 77}, {26254, 78}, {26269, 79},
//     {26284, 80}, {26297, 81}, {26309, 82}, {26320, 83}, {26330, 84}, {26339, 85}, {26347, 86}, {26355, 87}, {26362, 88}, {26369, 89},
//     {26376, 90}, {26382, 91}, {26389, 92}, {26396, 93}, {26403, 94}, {26411, 95}, {26422, 96}, {26444, 97}, {26521, 98}, {26800, 99},
//     {28075, 100},
// };

const uint16_t g_au16OcvTable[][3] = {
    // {18466, 1,    0},
    {0,     1,     0},    {20874, 75,   1},     {21967, 149,  2},
    {22720, 224,   3},    {23306, 299,  4},     {23768, 373,  5},
    {24147, 448,   6},    {24447, 522,  7},     {24660, 597,  8},
    {24801, 672,   9},    {24903, 746,  10},    {24983, 822,  11},
    {25043, 896,  12},    {25090, 970,  13},    {25131, 1044, 14},
    {25174, 1120, 15},    {25225, 1194, 16},    {25279, 1268, 17},
    {25331, 1344, 18},    {25378, 1418, 19},    {25422, 1492, 20},
    {25463, 1568, 21},    {25503, 1642, 22},    {25542, 1716, 23},
    {25577, 1791, 24},    {25610, 1866, 25},    {25640, 1940, 26},
    {25668, 2015, 27},    {25694, 2090, 28},    {25719, 2164, 29},
    {25743, 2239, 30},    {25767, 2314, 31},    {25790, 2388, 32},
    {25812, 2462, 33},    {25832, 2538, 34},    {25850, 2612, 35},
    {25867, 2686, 36},    {25882, 2762, 37},    {25896, 2836, 38},
    {25908, 2910, 39},    {25920, 2985, 40},    {25931, 3060, 41},
    {25941, 3134, 42},    {25950, 3209, 43},    {25959, 3284, 44},
    {25968, 3358, 45},    {25975, 3433, 46},    {25983, 3508, 47},
    {25990, 3582, 48},    {25996, 3656, 49},    {26003, 3732, 50},
    {26009, 3806, 51},    {26015, 3880, 52},    {26021, 3956, 53},
    {26027, 4030, 54},    {26033, 4104, 55},    {26038, 4179, 56},
    {26044, 4254, 57},    {26050, 4328, 58},    {26055, 4403, 59},
    {26061, 4478, 60},    {26067, 4552, 61},    {26073, 4627, 62},
    {26079, 4702, 63},    {26085, 4776, 64},    {26092, 4850, 65},
    {26099, 4926, 66},    {26106, 5000, 67},    {26114, 5074, 68},
    {26122, 5149, 69},    {26132, 5224, 70},    {26143, 5298, 71},
    {26155, 5373, 72},    {26169, 5448, 73},    {26185, 5522, 74},
    {26202, 5597, 75},    {26219, 5672, 76},    {26237, 5746, 77},
    {26254, 5820, 78},    {26269, 5895, 79},    {26284, 5970, 80},
    {26297, 6044, 81},    {26309, 6119, 82},    {26320, 6194, 83},
    {26330, 6268, 84},    {26339, 6343, 85},    {26347, 6418, 86},
    {26355, 6492, 87},    {26362, 6567, 88},    {26369, 6641, 89},
    {26376, 6717, 90},    {26382, 6791, 91},    {26389, 6865, 92},
    {26396, 6941, 93},    {26403, 7015, 94},    {26411, 7089, 95},
    {26422, 7163, 96},    {26444, 7239, 97},    {26521, 7313, 98},
    {26800, 7387, 99},    {28075, 7460, 100}
};



void Batt_UpdateRsocByOCV(void)
{
    uint8_t i = 0;

    // Skip if no pack voltage value.
    if ( !g_sAdcData.u16PackVolt )
    {
        g_sBatteryData.u8Rsoc = 0;
        return;
    }

    //
    // Calculate initial RSOC and remaining capacity according to OCV table.
    //
    if ( IS_BIT_CLR(g_u8BattFlags, BATT_FLAG_INIT) )
    {
        g_sBatteryData.u8Rsoc = 100;
        for ( i = 0; i < 100; i++ )
        {
            if ( (g_sAdcData.u16PackVolt >= g_au16OcvTable[i][0]) && (g_sAdcData.u16PackVolt < g_au16OcvTable[i+1][0] ) )
            {
                g_sBatteryData.fRemainCap = g_au16OcvTable[i][1];
                g_sBatteryData.u8Rsoc = g_au16OcvTable[i][2];
                break;
            }
        }
        SET_BIT(g_u8BattFlags, BATT_FLAG_INIT);
        return;
    }

    //
    // Calculate remaining capacity with charge/discharge current.
    //
    if ( g_sAdcData.u16ChargeCurr )
    {
        if ( g_sAdcData.u16ChargeCurr > 0x7FFF )
            g_sAdcData.u16ChargeCurr = 0x7FFF;

        g_sBatteryData.fRemainCap += (float)g_sAdcData.u16ChargeCurr / 3600;
    }
    else if ( g_sAdcData.u16DischargeCurr )
    {
        if ( g_sAdcData.u16DischargeCurr > 0x7FFF )
            g_sAdcData.u16DischargeCurr = 0x7FFF;

        g_sBatteryData.fRemainCap -= (float)g_sAdcData.u16DischargeCurr / 3600;
    }

    //
    // Subtract car strating capacity if detected.
    //
    if ( IS_BIT_SET(g_u16SystemFlags, SYS_FLAG_RELAY_CURR_DETECTED) )
    {
        g_sBatteryData.fRemainCap -= START_CAR_CAPACITY;
        CLR_BIT(g_u16SystemFlags, SYS_FLAG_RELAY_CURR_DETECTED);
    }

    // Keep remaining capacity between 0 and design capacity.
    if ( g_sBatteryData.fRemainCap <= 0 )
    {
        g_sBatteryData.fRemainCap = 0;
        g_sBatteryData.u8Rsoc = 0;
    }
    else if ( (g_sBatteryData.fRemainCap >= DESIGN_CAPACITY) || IS_BIT_SET(g_u8BattFlags, BATT_FLAG_FC) )
    {
        g_sBatteryData.fRemainCap = DESIGN_CAPACITY;
        g_sBatteryData.u8Rsoc = 100;
    }
    else
    {
        g_sBatteryData.u8Rsoc = (uint8_t)(g_sBatteryData.fRemainCap * 100 / DESIGN_CAPACITY);
    }


}

